var Ue=Object.defineProperty,Ke=Object.defineProperties;var ze=Object.getOwnPropertyDescriptors;var Ce=Object.getOwnPropertySymbols;var Je=Object.prototype.hasOwnProperty,We=Object.prototype.propertyIsEnumerable;var we=(e,t,a)=>t in e?Ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,F=(e,t)=>{for(var a in t||(t={}))Je.call(t,a)&&we(e,a,t[a]);if(Ce)for(var a of Ce(t))We.call(t,a)&&we(e,a,t[a]);return e},se=(e,t)=>Ke(e,ze(t));var w=(e,t,a)=>new Promise((o,s)=>{var i=m=>{try{l(a.next(m))}catch(h){s(h)}},c=m=>{try{l(a.throw(m))}catch(h){s(h)}},l=m=>m.done?o(m.value):Promise.resolve(m.value).then(i,c);l((a=a.apply(e,t)).next())});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function a(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=a(s);fetch(s.href,i)}})();const H=window.marked||null,E=window.hljs||null,Ee=window.renderMathInElement||null,De="assistme.conversations.v2",Pe="assistme.theme",ie="assistme.model";function Ye(){var o;if(["localhost","127.0.0.1","0.0.0.0"].includes(location.hostname))return"http://localhost:8001";if(window.ASSISTME_API_BASE)return window.ASSISTME_API_BASE;const t=document.querySelector('meta[name="assistme-api-base"]'),a=(o=t==null?void 0:t.content)==null?void 0:o.trim();return a||"https://assistme-virtualassistant-production.up.railway.app"}const L=Ye(),te={stream:`${L}/api/chat/stream`,chat:`${L}/api/chat/text`,conversations:`${L}/api/conversations`,conversationById:e=>`${L}/api/conversations/${e}`},$=[{id:"google/gemini-2.0-flash-exp:free",label:"Google Gemini 2.0 Flash Experimental",hint:"Google flash tier Â· multimodal Â· free",context:"1M context"},{id:"qwen/qwen3-coder:free",label:"Qwen3 Coder 480B A35B",hint:"Alibaba Qwen coder Â· 480B params",context:"262k context"},{id:"tngtech/deepseek-r1t2-chimera:free",label:"DeepSeek R1T2 Chimera",hint:"TNGTech + DeepSeek hybrid reasoning",context:"163k context"},{id:"microsoft/mai-ds-r1:free",label:"Microsoft MAI DS R1",hint:"Microsoft x DeepSeek research model",context:"163k context"},{id:"openai/gpt-oss-20b:free",label:"OpenAI GPT OSS 20B",hint:"Open-source 20B preview, free tier",context:"128k context"},{id:"z-ai/glm-4.5-air:free",label:"Zhipu GLM 4.5 Air",hint:"Zhipu AI lightweight flagship",context:"128k context"},{id:"meta-llama/llama-3.3-70b-instruct:free",label:"Meta Llama 3.3 70B Instruct",hint:"Meta frontier instruct tuning",context:"131k context"},{id:"nvidia/nemotron-nano-9b-v2:free",label:"NVIDIA Nemotron Nano 9B V2",hint:"NVIDIA RAG-ready small model",context:"131k context"},{id:"mistralai/mistral-nemo:free",label:"Mistral Nemo",hint:"Mistral + NVIDIA collaboration",context:"128k context"},{id:"moonshotai/kimi-dev-72b:free",label:"MoonshotAI Kimi Dev 72B",hint:"MoonshotAI developer-tuned",context:"128k context"}],Ie={general:{label:"General Q&A",description:"Balanced prompts covering product questions, support triage, and structured summaries. Measures first-token latency and sustained throughput across 256-token completions.",command:"assistme-bench run --scenario general --output logs/general.json",accelerators:["1 Ã— NVIDIA A100 80GB Â· 75% GPU util Â· 175 tok/s sustained","1 Ã— NVIDIA H100 80GB Â· 85% GPU util Â· 215 tok/s sustained","2 Ã— RTX 4090 Â· tensor parallel Â· 160 tok/s sustained"],models:[{id:"google/gemini-2.0-flash-exp:free",latency:"0.82 s",throughput:"180 tok/s",context:"1M tokens",bestFor:"Multimodal answers & snippets",accelerator:"A100 80GB"},{id:"meta-llama/llama-3.3-70b-instruct:free",latency:"1.14 s",throughput:"142 tok/s",context:"131k tokens",bestFor:"Structured responses",accelerator:"H100 80GB"},{id:"z-ai/glm-4.5-air:free",latency:"0.96 s",throughput:"128 tok/s",context:"128k tokens",bestFor:"Low-cost multilingual",accelerator:"RTX 4090"}]},coding:{label:"Coding & reasoning",description:"Stress test long-reasoning traces, code review, and unit test generation. Includes adversarial math + tool-use prompts.",command:"assistme-bench run --scenario coding --trace --compare --accelerator H100",accelerators:["1 Ã— NVIDIA H100 80GB Â· bf16 Â· 185 tok/s with streaming","1 Ã— NVIDIA A100 40GB Â· fp16 Â· 128 tok/s","2 Ã— NVIDIA L40S Â· tensor parallel Â· 150 tok/s"],models:[{id:"qwen/qwen3-coder:free",latency:"1.06 s",throughput:"168 tok/s",context:"262k tokens",bestFor:"Code generation & debug",accelerator:"H100 80GB"},{id:"tngtech/deepseek-r1t2-chimera:free",latency:"1.22 s",throughput:"150 tok/s",context:"163k tokens",bestFor:"Chain-of-thought reasoning",accelerator:"A100 80GB"},{id:"openai/gpt-oss-20b:free",latency:"0.94 s",throughput:"132 tok/s",context:"128k tokens",bestFor:"Lightweight OSS baseline",accelerator:"L40S"}]},creative:{label:"Creative writing",description:"Evaluates story continuity, tone matching, and multilingual output with 512-token completions.",command:"assistme-bench run --scenario creative --duration 300 --accelerator A100",accelerators:["1 Ã— NVIDIA A100 80GB Â· fp16 Â· 140 tok/s","1 Ã— NVIDIA H100 80GB Â· fp8 Â· 195 tok/s","1 Ã— RTX 6000 Ada Â· fp16 Â· 110 tok/s"],models:[{id:"moonshotai/kimi-dev-72b:free",latency:"1.35 s",throughput:"138 tok/s",context:"128k tokens",bestFor:"Narrative tone & long form",accelerator:"A100 80GB"},{id:"mistralai/mistral-nemo:free",latency:"1.02 s",throughput:"152 tok/s",context:"128k tokens",bestFor:"Creative ideation",accelerator:"L40S"},{id:"google/gemini-2.0-flash-exp:free",latency:"0.88 s",throughput:"176 tok/s",context:"1M tokens",bestFor:"Storyboarding & imagery cues",accelerator:"H100 80GB"}]}};var Oe;const ce=((Oe=$[0])==null?void 0:Oe.id)||null,n={app:document.getElementById("app"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarCloseBtn:document.getElementById("sidebarCloseBtn"),newChatBtn:document.getElementById("newChatBtn"),conversationSearch:document.getElementById("conversationSearch"),conversations:document.getElementById("conversations"),pinnedPrompts:document.getElementById("pinnedPrompts"),clearHistoryBtn:document.getElementById("clearHistoryBtn"),settingsBtn:document.getElementById("settingsBtn"),themeToggleBtn:document.getElementById("themeToggleBtn"),modelSelector:document.getElementById("modelSelector"),modelButton:document.getElementById("modelButton"),modelDropdown:document.getElementById("modelDropdown"),welcomePanel:document.getElementById("welcomePanel"),starterGrid:document.getElementById("starterGrid"),chatMessages:document.getElementById("chatMessages"),chatThread:document.getElementById("chatThread"),workspace:document.getElementById("workspace"),assistantStatus:document.getElementById("assistantStatus"),statusDot:document.querySelector("#assistantStatus .status-dot"),statusText:document.querySelector("#assistantStatus span:nth-of-type(2)"),messageInput:document.getElementById("messageInput"),composer:document.getElementById("composer"),sendButton:document.getElementById("sendButton"),composerQuick:document.getElementById("composerQuick"),benchmarkBtn:document.getElementById("benchmarkBtn"),benchmarkModal:document.getElementById("benchmarkModal"),benchmarkBackdrop:document.getElementById("benchmarkBackdrop"),benchmarkClose:document.getElementById("benchmarkClose"),benchmarkTabs:document.getElementById("benchmarkTabs"),benchmarkTableBody:document.getElementById("benchmarkTableBody"),benchmarkDescription:document.getElementById("benchmarkDescription"),benchmarkCommand:document.getElementById("benchmarkCommand"),benchmarkCopy:document.getElementById("benchmarkCopy"),benchmarkAccelerators:document.getElementById("benchmarkAccelerators"),ai4bharatBtn:document.getElementById("ai4bharatBtn"),ai4bharatModal:document.getElementById("ai4bharatModal"),ai4bharatBackdrop:document.getElementById("ai4bharatBackdrop"),ai4bharatClose:document.getElementById("ai4bharatClose"),ai4bharatTabs:document.getElementById("ai4bharatTabs"),translatePanel:document.getElementById("translatePanel"),detectPanel:document.getElementById("detectPanel"),transliteratePanel:document.getElementById("transliteratePanel"),translateSource:document.getElementById("translateSource"),translateTarget:document.getElementById("translateTarget"),translateInput:document.getElementById("translateInput"),translateBtn:document.getElementById("translateBtn"),translateResult:document.getElementById("translateResult"),translateOutput:document.getElementById("translateOutput"),detectInput:document.getElementById("detectInput"),detectBtn:document.getElementById("detectBtn"),detectResult:document.getElementById("detectResult"),detectOutput:document.getElementById("detectOutput"),transliterateSource:document.getElementById("transliterateSource"),transliterateTarget:document.getElementById("transliterateTarget"),transliterateInput:document.getElementById("transliterateInput"),transliterateBtn:document.getElementById("transliterateBtn"),transliterateResult:document.getElementById("transliterateResult"),transliterateOutput:document.getElementById("transliterateOutput"),inlineSuggestions:document.getElementById("inlineSuggestions"),latencyMetric:document.getElementById("latencyMetric"),tokenMetric:document.getElementById("tokenMetric"),voiceBtn:document.getElementById("voiceBtn"),toastContainer:document.getElementById("toastContainer"),uploadBtn:document.getElementById("uploadBtn")},r={conversations:[],activeConversation:null,currentModel:ce,backendHealthy:null,isStreaming:!1,typingNode:null,abortController:null,voice:{recognition:null,listening:!1,available:!1},inputHistory:{items:[],index:-1},activeBenchmarkScenario:"general"},Qe=new Set(["P","BR","PRE","CODE","SPAN","STRONG","EM","UL","OL","LI","BLOCKQUOTE","TABLE","THEAD","TBODY","TR","TH","TD","HR","A","H1","H2","H3","H4","H5","H6"]),Xe=Object.freeze([]),Ze=Object.freeze(["href","title","target","rel"]),et=Object.freeze(["class"]),tt=Object.freeze(["colspan","rowspan"]),nt=Object.freeze(["colspan","rowspan"]),at=3e4;let Be=null;function ot(e){switch(e){case"A":return Ze;case"CODE":case"PRE":return et;case"TH":return tt;case"TD":return nt;default:return Xe}}function st(e){if(typeof e!="string"||e.trim()==="")return document.createDocumentFragment();const a=new DOMParser().parseFromString(e,"text/html");if(!(a!=null&&a.body)||a.querySelector("parsererror"))return document.createDocumentFragment();a.querySelectorAll("script, iframe, object, embed, style, link").forEach(c=>c.remove());const o=document.createTreeWalker(a.body,NodeFilter.SHOW_ELEMENT,null),s=[];for(;o.nextNode();){const c=o.currentNode,l=c.tagName;if(!Qe.has(l)){s.push(c);continue}const m=ot(l);Array.from(c.attributes).forEach(h=>{const g=h.name.toLowerCase(),b=h.value||"";if(!m.includes(g)){c.removeAttribute(h.name);return}if(l==="A"&&g==="href"){if(!/^(https?:|mailto:|tel:)/i.test(b)){c.removeAttribute(h.name);return}c.setAttribute("target","_blank"),c.setAttribute("rel","noopener noreferrer nofollow")}if(l==="A"&&g==="target"&&b!=="_blank"&&c.setAttribute("target","_blank"),l==="A"&&g==="rel"&&c.setAttribute("rel","noopener noreferrer nofollow"),(l==="CODE"||l==="PRE")&&g==="class"){const B=b.split(/\s+/).filter(T=>T.startsWith("language-"));B.length>0?c.className=B.join(" "):c.removeAttribute("class")}})}s.forEach(c=>{const l=a.createTextNode(c.textContent||"");c.replaceWith(l)});const i=document.createDocumentFragment();for(;a.body.firstChild;)i.appendChild(a.body.firstChild);return i}function I(){n.messageInput&&requestAnimationFrame(()=>{if(n.messageInput){n.messageInput.focus({preventScroll:!0});try{const e=n.messageInput.value.length;n.messageInput.setSelectionRange(e,e)}catch(e){}}})}function pe(){return w(this,null,function*(){try{const e=yield fetch(`${L}/api/status`,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)});if(!e.ok)return console.warn("Status endpoint returned non-ok response, trying fallback"),Se();const t=yield e.json();console.log("Backend status response:",t);const a=t.api_key_configured===!0,o=t.status==="operational"&&t.chat_available===!0;return console.log(`Backend health: ${o?"healthy":"unhealthy"}, Production: ${a}`),P(o,o?null:"Backend health check reported degraded status",a),o}catch(e){return console.warn("Backend status request failed:",e),Se()}})}function Se(){return w(this,null,function*(){try{const e=yield fetch(`${L}/health`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(e.ok)return console.log("Fallback health endpoint successful"),P(!0),!0;console.warn("Fallback health endpoint failed with status:",e.status)}catch(e){console.warn("Fallback health check error:",e)}return P(!1,"Backend health check failed"),!1})}function P(e,t=null,a=!1){const o=r.backendHealthy;r.backendHealthy=e,n.assistantStatus&&(e?(n.assistantStatus.classList.remove("offline"),n.statusDot&&n.statusDot.classList.add("live"),n.statusText&&(a?n.statusText.textContent="All systems operational Â· Responses stream in realtime":n.statusText.textContent="AssistMe online")):(n.assistantStatus.classList.add("offline"),n.statusDot&&n.statusDot.classList.remove("live"),n.statusText&&(n.statusText.textContent=t||"AssistMe offline"))),o!==e&&console.log(`Backend status changed: ${e?"online":"offline"}${a?" (production mode)":""}`)}function rt(){Be===null&&(Be=window.setInterval(()=>{pe().catch(()=>{})},at))}function xe(e){const t=(e||"").trim();if(!t){const s="ðŸ”Œ **Backend Offline** - I'm in preview mode. The backend will reconnect automatically. Your messages are saved locally.";return{response:s,tokens:s.split(/\s+/).length}}const a=t.toLowerCase();let o;return a.includes("hello")||a.includes("hi")?o="ðŸ‘‹ Hello! I'm in offline preview mode right now. This response is simulated, but your message is saved. I'll reconnect automatically when the backend comes back online.":a.includes("code")||a.includes("python")||a.includes("javascript")||a.includes("bug")||a.includes("error")?o="ðŸ’» **Code Help (Offline Preview)** - I can't analyze code right now, but here's a tip: check your error message, search Stack Overflow, and I'll give you detailed help when I reconnect. Your code snippet is saved locally.":a.includes("help")||a.includes("support")||a.includes("issue")?o="ðŸ†˜ **Support (Offline Mode)** - I've saved your request. While offline, I can only provide basic guidance. When the backend reconnects, you'll get a full detailed response. Keep trying - I'll be back soon!":a.includes("status")||a.includes("online")||a.includes("backend")?o="ðŸ”„ **Status Check** - The backend is currently offline. Health checks run every 30 seconds. You can keep using the app - all messages are saved locally and will sync when I reconnect.":o=`ðŸ“ **Offline Preview** - I'm offline, so this is a lightweight response. Your full question is saved: "${t.substring(0,100)}${t.length>100?"...":""}" - I'll provide a complete answer when I reconnect.`,{response:o,tokens:o.split(/\s+/).length}}function it(e){const t=e.trim();if(!t)return;const a=r.inputHistory;if(a.items[0]===t){a.index=-1;return}a.items.unshift(t),a.items.length>50&&a.items.pop(),a.index=-1}function Ae(e){var o,s;if(!n.messageInput)return;const t=r.inputHistory,a=t.items;if(!(!Array.isArray(a)||a.length===0)){if(e==="up"){const i=t.index+1;if(i>=a.length)return;t.index=i,n.messageInput.value=String((o=a[i])!=null?o:"")}else t.index<=0?(t.index=-1,n.messageInput.value=""):(t.index-=1,n.messageInput.value=String((s=a[t.index])!=null?s:""));oe(),k(),I()}}function ae(e,t,a,o=""){const{selectionStart:s,selectionEnd:i,value:c}=e,l=s!==i,m=c.slice(s,i),h=l?m:o,g=c.slice(0,s),b=c.slice(i),N=`${g}${t}${h}${a}${b}`,B=g.length+t.length,T=B+h.length;e.value=N,e.setSelectionRange(B,T)}function Te(e){if(!n.messageInput)return;const t=n.messageInput;if(e==="clear"){t.value="",r.inputHistory.index=-1,k(),I();return}if(e==="bold")ae(t,"**","**","bold text");else if(e==="italic")ae(t,"_","_","italic text");else if(e==="code"){const{selectionStart:a,selectionEnd:o,value:s}=t,i=s.slice(a,o);i.includes(`
`)?ae(t,"```\n","\n```",i||"code block"):ae(t,"`","`",i||"code")}k(),I()}function ct(e){const t=$.find(a=>a.id===e);return t?t.label:e}function lt(e){return!e||!Object.prototype.hasOwnProperty.call(Ie,e)?null:Ie[e]}function He(e){const t=lt(e);if(!t||!n.benchmarkTableBody)return;const a=String(e);r.activeBenchmarkScenario=a,n.benchmarkTabs&&n.benchmarkTabs.querySelectorAll(".benchmark-tab").forEach(o=>{const s=o.dataset.scenario===a;o.classList.toggle("active",s),o.setAttribute("aria-selected",s?"true":"false")}),n.benchmarkDescription&&(n.benchmarkDescription.textContent=t.description),n.benchmarkTableBody.replaceChildren(),t.models.forEach((o,s)=>{const i=document.createElement("tr");s===0&&i.classList.add("top-performer");const c=document.createElement("td");c.className="model-name",c.textContent=ct(o.id);const l=document.createElement("td");l.textContent=o.latency;const m=document.createElement("td");m.textContent=o.throughput;const h=document.createElement("td");h.textContent=o.context;const g=document.createElement("td");g.textContent=o.bestFor;const b=document.createElement("td");b.textContent=o.accelerator,i.appendChild(c),i.appendChild(l),i.appendChild(m),i.appendChild(h),i.appendChild(g),i.appendChild(b),n.benchmarkTableBody.appendChild(i)}),n.benchmarkCommand&&(n.benchmarkCommand.textContent=t.command),n.benchmarkAccelerators&&(n.benchmarkAccelerators.replaceChildren(),t.accelerators.forEach(o=>{const s=document.createElement("li");s.textContent=o,n.benchmarkAccelerators.appendChild(s)}))}function dt(){if(!n.benchmarkModal)return;n.benchmarkModal.classList.add("open"),n.benchmarkModal.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open"),He(r.activeBenchmarkScenario||"general");const e=n.benchmarkClose||n.benchmarkModal.querySelector("button");e==null||e.focus({preventScroll:!0})}function le(){var e;n.benchmarkModal&&(n.benchmarkModal.classList.remove("open"),n.benchmarkModal.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open"),(e=n.benchmarkBtn)==null||e.focus({preventScroll:!0}))}function ut(e){const t=e.target.closest(".benchmark-tab");t!=null&&t.dataset.scenario&&t.dataset.scenario!==r.activeBenchmarkScenario&&He(t.dataset.scenario)}function mt(){return w(this,null,function*(){var t;if(!n.benchmarkCommand)return;const e=n.benchmarkCommand.textContent||"";if(e.trim())try{yield(t=navigator.clipboard)==null?void 0:t.writeText(e.trim()),y("Benchmark command copied to clipboard","success")}catch(a){console.warn("Clipboard copy failed",a),y("Unable to copy command. Press âŒ˜/Ctrl + C instead.","error")}})}function pt(){var e;return!!((e=n.benchmarkModal)!=null&&e.classList.contains("open"))}function ft(e){e.key==="Escape"&&pt()&&(e.preventDefault(),le()),e.key==="Escape"&&gt()&&(e.preventDefault(),de())}function ht(){if(!n.ai4bharatModal)return;n.ai4bharatModal.classList.add("open"),n.ai4bharatModal.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open"),$e("translate");const e=n.ai4bharatClose||n.ai4bharatModal.querySelector("button");e==null||e.focus({preventScroll:!0})}function de(){var e;n.ai4bharatModal&&(n.ai4bharatModal.classList.remove("open"),n.ai4bharatModal.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open"),(e=n.ai4bharatBtn)==null||e.focus({preventScroll:!0}))}function gt(){var e;return!!((e=n.ai4bharatModal)!=null&&e.classList.contains("open"))}function vt(e){const t=e.target.closest(".ai4bharat-tab");t!=null&&t.dataset.tab&&$e(t.dataset.tab)}function $e(e){var t;(t=n.ai4bharatTabs)==null||t.querySelectorAll(".ai4bharat-tab").forEach(a=>{a.classList.toggle("active",a.dataset.tab===e)}),[n.translatePanel,n.detectPanel,n.transliteratePanel].forEach(a=>{a&&a.classList.toggle("active",a.id===`${e}Panel`)})}function yt(){return w(this,null,function*(){var o,s;if(!n.translateInput||!n.translateOutput||!n.translateResult)return;const e=n.translateInput.value.trim(),t=((o=n.translateSource)==null?void 0:o.value)||"en",a=((s=n.translateTarget)==null?void 0:s.value)||"hi";if(!e){y("Please enter text to translate","warning");return}try{n.translateBtn.disabled=!0,n.translateBtn.textContent="Translating...";const c=yield(yield fetch(`${L}/api/ai4bharat/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,source_language:t,target_language:a})})).json();if(c.success)n.translateOutput.textContent=c.translated_text||c.response||"Translation completed",n.translateResult.style.display="block",y("Translation completed","success");else throw new Error(c.error||"Translation failed")}catch(i){console.error("Translation error:",i),y(`Translation failed: ${i.message}`,"error")}finally{n.translateBtn.disabled=!1,n.translateBtn.textContent="Translate"}})}function bt(){return w(this,null,function*(){if(!n.detectInput||!n.detectOutput||!n.detectResult)return;const e=n.detectInput.value.trim();if(!e){y("Please enter text to analyze","warning");return}try{n.detectBtn.disabled=!0,n.detectBtn.textContent="Detecting...";const a=yield(yield fetch(`${L}/api/ai4bharat/detect-language`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})})).json();if(a.success){const o=a.language_name||a.detected_language,s=a.confidence?` (${Math.round(a.confidence*100)}% confidence)`:"";n.detectOutput.textContent=`Detected: ${o}${s}`,n.detectResult.style.display="block",y("Language detected","success")}else throw new Error(a.error||"Language detection failed")}catch(t){console.error("Language detection error:",t),y(`Detection failed: ${t.message}`,"error")}finally{n.detectBtn.disabled=!1,n.detectBtn.textContent="Detect Language"}})}function kt(){return w(this,null,function*(){var o,s;if(!n.transliterateInput||!n.transliterateOutput||!n.transliterateResult)return;const e=n.transliterateInput.value.trim(),t=((o=n.transliterateSource)==null?void 0:o.value)||"hi",a=((s=n.transliterateTarget)==null?void 0:s.value)||"en";if(!e){y("Please enter text to transliterate","warning");return}try{n.transliterateBtn.disabled=!0,n.transliterateBtn.textContent="Transliterating...";const c=yield(yield fetch(`${L}/api/ai4bharat/transliterate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,source_script:t,target_script:a})})).json();if(c.success)n.transliterateOutput.textContent=c.transliterated_text||c.response||"Transliteration completed",n.transliterateResult.style.display="block",y("Transliteration completed","success");else throw new Error(c.error||"Transliteration failed")}catch(i){console.error("Transliteration error:",i),y(`Transliteration failed: ${i.message}`,"error")}finally{n.transliterateBtn.disabled=!1,n.transliterateBtn.textContent="Transliterate"}})}function ue(e,t){if(!e)return;const a=t||"",o=H!=null&&H.parse?H.parse(a):a,s=st(o);if(e.replaceChildren(),e.appendChild(s),E!=null&&E.highlightElement&&e.querySelectorAll("pre code").forEach(i=>{try{E.highlightElement(i)}catch(c){console.warn("Highlighting error",c)}}),typeof Ee=="function")try{Ee(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})}catch(i){console.warn("Math rendering error",i)}}function Re(e=null){var a;const t=`local-${Date.now()}`;return{id:t,localId:t,serverId:null,title:"New chat",model:(a=e!=null?e:r.currentModel)!=null?a:null,createdAt:Date.now(),updatedAt:Date.now(),messages:[]}}function fe(){try{localStorage.setItem(De,JSON.stringify(r.conversations))}catch(e){console.warn("Failed to persist conversations",e)}}function Ct(){try{const e=localStorage.getItem(De);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.warn("Failed to load conversations",e),[]}}function wt(e){const a=Date.now()-e,o=Math.round(a/6e4);if(o<1)return"Just now";if(o<60)return`${o}m ago`;const s=Math.round(o/60);return s<24?`${s}h ago`:new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric"})}function ne(e=""){if(!n.conversations)return;const t=e.trim().toLowerCase();n.conversations.replaceChildren();const a=r.conversations.slice().sort((o,s)=>s.updatedAt-o.updatedAt).filter(o=>t?o.title.toLowerCase().includes(t):!0);if(a.length===0){const o=document.createElement("div");o.className="conversation-item",o.textContent="No conversations yet. Start a new chat to see history here.",o.style.opacity="0.65",n.conversations.appendChild(o);return}a.forEach(o=>{const s=document.createElement("button");s.className="conversation-item",r.activeConversation&&o.id===r.activeConversation.id&&s.classList.add("active"),s.dataset.id=o.id;const i=document.createElement("div");i.className="conversation-title",i.textContent=o.title||"Untitled chat";const c=document.createElement("div");c.className="conversation-date",c.textContent=wt(o.updatedAt),s.appendChild(i),s.appendChild(c),n.conversations.appendChild(s)})}function Et(){const e=localStorage.getItem(Pe),a=(e?e==="dark":window.matchMedia("(prefers-color-scheme: dark)").matches)?"dark":"light";document.documentElement.setAttribute("data-theme",a),_e(a)}function It(){const t=(document.documentElement.getAttribute("data-theme")==="dark"?"dark":"light")==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",t),localStorage.setItem(Pe,t),_e(t)}function _e(e){var a;const t=(a=n.themeToggleBtn)==null?void 0:a.querySelector("i");t&&(t.classList.remove("fa-sun","fa-moon"),t.classList.add(e==="dark"?"fa-sun":"fa-moon"))}function R(e){return e&&$.some(t=>t.id===e)?e:ce}function he(){if(!n.modelDropdown)return;n.modelDropdown.replaceChildren();const e=document.createElement("div");e.className="model-dropdown-header",e.textContent="Select a model",n.modelDropdown.appendChild(e),$.forEach(t=>{const a=document.createElement("button");a.className="model-option",a.type="button",a.dataset.model=t.id,a.setAttribute("role","option"),a.setAttribute("tabindex","0");const o=t.id===r.currentModel;a.setAttribute("aria-selected",o?"true":"false");const s=document.createElement("span");s.className="model-option-title",s.textContent=t.label;const i=document.createElement("span");i.className="model-option-desc",i.textContent=t.hint;const c=document.createElement("span");c.className="model-option-meta",c.textContent=t.context,a.appendChild(s),a.appendChild(i),a.appendChild(c),o&&a.classList.add("active"),a.addEventListener("click",()=>{Bt(t.id),ge(!1)}),n.modelDropdown.appendChild(a)}),Fe(),n.modelDropdown.scrollTop=0}function Fe(){if(!n.modelButton)return;const e=$.find(o=>o.id===r.currentModel)||$[0],t=n.modelButton.querySelector(".model-name"),a=n.modelButton.querySelector(".model-hint");t&&(t.textContent=(e==null?void 0:e.label)||"Select a model"),a&&(a.textContent=(e==null?void 0:e.hint)||"Pick any model to start chatting"),r.currentModel&&localStorage.setItem(ie,r.currentModel)}function ge(e){var a;if(!n.modelDropdown)return;const t=typeof e=="boolean"?e:!n.modelDropdown.classList.contains("open");if(n.modelDropdown.classList.toggle("open",t),n.modelButton&&n.modelButton.setAttribute("aria-expanded",t?"true":"false"),t){const o=n.modelDropdown.querySelector(".model-option.active")||n.modelDropdown.querySelector(".model-option");o==null||o.focus()}else(a=n.modelButton)==null||a.focus(),I()}function Bt(e){r.currentModel=R(e),r.activeConversation&&(r.activeConversation.model=r.currentModel,r.activeConversation.messages.length>0&&D()),Fe(),he(),k(),I()}function St(e){n.modelSelector&&!n.modelSelector.contains(e.target)&&ge(!1),n.sidebar&&!n.sidebar.contains(e.target)&&n.sidebar.classList.contains("open")&&n.sidebar.classList.remove("open")}function Q(){n.welcomePanel&&(n.welcomePanel.style.display="none"),n.chatMessages&&n.chatMessages.classList.add("active")}function ve(e){const t=document.createElement("article");t.className=`message ${e}`;const a=document.createElement("div");a.className="message-avatar";const o=document.createElement("i");o.className=e==="user"?"fa-solid fa-user":"fa-solid fa-robot",o.setAttribute("aria-hidden","true"),a.appendChild(o);const s=document.createElement("div");s.className="message-content";const i=document.createElement("div");i.className="prose",s.appendChild(i);const c=document.createElement("div");c.className="message-metadata",c.style.display="none",s.appendChild(c);const l=document.createElement("div");l.className="message-actions";const m=document.createElement("button");m.className="message-action-btn",m.title="Copy to clipboard";const h=document.createElement("i");if(h.className="fa-solid fa-copy",h.setAttribute("aria-hidden","true"),m.appendChild(h),m.addEventListener("click",()=>{var g;(g=navigator.clipboard)==null||g.writeText(i.textContent||"").then(()=>y("Copied to clipboard")).catch(()=>y("Copy failed","error"))}),l.appendChild(m),e==="assistant"&&"speechSynthesis"in window){const g=document.createElement("button");g.className="message-action-btn",g.title="Listen to response";const b=document.createElement("i");b.className="fa-solid fa-volume-high",b.setAttribute("aria-hidden","true"),g.appendChild(b),g.addEventListener("click",()=>Ht(i.textContent||"")),l.appendChild(g)}return s.appendChild(l),t.appendChild(a),t.appendChild(s),n.chatMessages.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"end"}),{wrapper:t,text:i,metadata:c}}function xt(){if(!n.chatMessages)return;ee();const e=document.createElement("div");e.className="typing-indicator";const t=document.createElement("div");t.className="message-avatar";const a=document.createElement("i");a.className="fa-solid fa-robot",a.setAttribute("aria-hidden","true"),t.appendChild(a);const o=document.createElement("div");o.className="typing-dots";for(let s=0;s<3;s+=1){const i=document.createElement("span");i.className="typing-dot",o.appendChild(i)}e.appendChild(t),e.appendChild(o),n.chatMessages.appendChild(e),e.scrollIntoView({behavior:"smooth",block:"end"}),r.typingNode=e}function ee(){r.typingNode&&r.typingNode.parentNode&&r.typingNode.parentNode.removeChild(r.typingNode),r.typingNode=null}function X(e,t){n.latencyMetric&&(n.latencyMetric.textContent=e?`${Math.round(e)} ms`:"â€”"),n.tokenMetric&&(n.tokenMetric.textContent=t?`${t} tokens`:"â€” tokens")}function y(e,t="info",a=3200){if(!n.toastContainer)return;const o=document.createElement("div");o.className=`toast ${t}`,o.textContent=e,n.toastContainer.appendChild(o),setTimeout(()=>{o.classList.add("fade"),setTimeout(()=>{o.remove()},300)},a)}function Me(e){if(!e)return;const t=e.messages.find(s=>s.role==="user"&&s.content.trim());if(!t)return;const o=t.content.trim().replace(/\s+/g," ");e.title=o.length>60?`${o.slice(0,57)}...`:o}function D(){var t;if(!r.activeConversation)return;r.activeConversation.updatedAt=Date.now();const e=JSON.parse(JSON.stringify(r.activeConversation));e.localId=r.activeConversation.localId||r.activeConversation.id,r.conversations=r.conversations.filter(a=>!(r.activeConversation.serverId&&a.serverId===r.activeConversation.serverId||a.id===e.id||e.localId&&a.id===e.localId)),r.conversations.unshift(e),r.conversations=r.conversations.slice(0,60),fe(),ne(((t=n.conversationSearch)==null?void 0:t.value)||"")}function Ge(){n.messageInput&&(n.messageInput.value="",oe()),n.sendButton&&(n.sendButton.classList.add("disabled"),n.sendButton.disabled=!0)}function qe(){n.conversations&&n.conversations.querySelectorAll(".conversation-item").forEach(e=>{e.classList.toggle("active",r.activeConversation&&e.dataset.id===r.activeConversation.id)})}function ye(e,{resetView:t=!0}={}){r.activeConversation=e,r.inputHistory.index=-1;const a=R(e.model||r.currentModel);r.currentModel=a,r.activeConversation.model=a,t&&n.chatMessages&&n.chatMessages.replaceChildren(),ee(),n.welcomePanel&&(n.welcomePanel.style.display=e.messages.length===0?"":"none"),e.messages.forEach(o=>{const s=ve(o.role);o.role==="assistant"?ue(s.text,o.content):s.text.textContent=o.content,o.metadata?Z(s.metadata,o.metadata):(s.metadata.style.display="none",s.metadata.replaceChildren())}),qe(),he(),k(),I()}function Z(e,t){if(!e)return;e.replaceChildren();const a={model:r.currentModel,latency:null,tokens:null},o=F(F({},a),t),s=[];if(o.model&&s.push({icon:"fa-solid fa-robot",text:o.model}),o.latency&&s.push({icon:"fa-solid fa-gauge-high",text:`${o.latency} ms`}),o.tokens&&s.push({icon:"fa-solid fa-layer-group",text:`${o.tokens} tok`}),s.length===0){e.style.display="none";return}s.forEach((i,c)=>{if(c>0){const h=document.createElement("span");h.className="meta-separator",h.textContent="Â·",e.appendChild(h)}const l=document.createElement("span");l.className="meta-entry";const m=document.createElement("i");m.className=i.icon,m.setAttribute("aria-hidden","true"),l.appendChild(m),l.appendChild(document.createTextNode(i.text)),e.appendChild(l)}),e.style.display="flex"}function At(e){const t=r.conversations.find(a=>a.id===e);t&&(r.activeConversation&&r.activeConversation.messages.length>0&&D(),ye(se(F({},t),{messages:t.messages.map(a=>F({},a))})))}function oe(){n.messageInput&&(n.messageInput.style.height="auto",n.messageInput.style.height=`${Math.min(n.messageInput.scrollHeight,200)}px`)}function k(){if(!n.messageInput||!n.sendButton){console.warn("messageInput or sendButton not found");return}oe(),n.messageInput.disabled=!1,n.messageInput.style.pointerEvents="auto",n.messageInput.style.opacity="1",n.messageInput.style.display="block",n.messageInput.removeAttribute("readonly");const t=n.messageInput.value.trim().length>0&&!r.isStreaming&&!!R(r.currentModel);n.sendButton.classList.toggle("disabled",!t),n.sendButton.disabled=!t}function Ve(e,t){if(e.serverId)return[t];const a=e.messages.map(o=>({role:o.role,content:o.content}));return a.push(t),a}function je(){var a;const e=(a=r.activeConversation)==null?void 0:a.model,t=R(e||r.currentModel);return r.currentModel=t,r.activeConversation&&(r.activeConversation.model=t),t}function Tt(e){return w(this,null,function*(){if(!r.activeConversation)return null;const t=je(),a={messages:Ve(r.activeConversation,e),model:t};r.activeConversation.serverId&&(a.conversation_id=r.activeConversation.serverId);const o=yield fetch(te.chat,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),s=yield o.json().catch(()=>({}));if(!o.ok)throw new Error((s==null?void 0:s.error)||`HTTP ${o.status}`);if(s!=null&&s.error)throw new Error(s.error);return P(!0),s})}function Mt(e){return w(this,null,function*(){var h,g,b,N,B,T,G,q,V,j,U,K,z,J,W;if(!r.activeConversation)return;const t=je(),a={messages:Ve(r.activeConversation,e),model:t};r.activeConversation.serverId&&(a.conversation_id=r.activeConversation.serverId),console.log("Sending request to:",te.stream),console.log("Payload:",a);const o=new AbortController;r.abortController=o,r.isStreaming=!0,k(),xt();const s={role:"assistant",content:"",createdAt:Date.now(),metadata:{model:t}};r.activeConversation.messages.push(s);const i=ve("assistant"),c=performance.now();let l=null,m=t;if(r.backendHealthy===!1&&(yield pe())&&(r.backendHealthy=!0),r.backendHealthy===!1){const C=xe(e.content);s.content=C.response,i.text.textContent=s.content;const p=Math.round(performance.now()-c);s.metadata={model:`${t||"offline/mock"}`,latency:p,tokens:C.tokens},Z(i.metadata,s.metadata),X(p,C.tokens),Q(),ee(),r.isStreaming=!1,k(),D(),I();return}try{const C=yield fetch(te.stream,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:o.signal});if(!C.ok)throw new Error(`HTTP ${C.status}`);P(!0);const p=(h=C.body)==null?void 0:h.getReader();if(!p)throw new Error("Streaming not supported in this browser");const u=new TextDecoder;let d="";for(;;){const{value:v,done:O}=yield p.read();if(O)break;d+=u.decode(v,{stream:!0});let S,_;for(;S=d.indexOf(`

`),_=2,S<0&&(S=d.indexOf(`\r
\r
`),_=4),!(S<0);){const x=d.slice(0,S);d=d.slice(S+_),console.log("Raw SSE event:",x);const f=Le(x);if(console.log("Parsed SSE event:",f),!!f){if(f.event==="delta"&&((g=f.data)!=null&&g.content)&&(console.log("Adding delta content:",f.data.content),s.content+=f.data.content,i.text.textContent=s.content,console.log("Updated content:",s.content)),f.event==="error")throw new Error(((b=f.data)==null?void 0:b.message)||"Streaming failed");if(f.event==="done"){console.log("Stream done, final data:",f.data),s.content=((N=f.data)==null?void 0:N.response)||s.content,i.text.textContent=s.content,l=((B=f.data)==null?void 0:B.tokens)||null,(T=f.data)!=null&&T.model&&(m=f.data.model),(G=f.data)!=null&&G.notice&&y(f.data.notice,"info");const M=(q=f.data)==null?void 0:q.conversation_id;typeof M=="number"&&M>0&&(r.activeConversation.localId=r.activeConversation.localId||r.activeConversation.id,r.activeConversation.serverId=M,r.activeConversation.id=`server-${M}`);const Y=(V=f.data)==null?void 0:V.title;Y?r.activeConversation.title=Y:Me(r.activeConversation)}}}}if(d+=u.decode(),d.trim()){const v=Le(d);(v==null?void 0:v.event)==="delta"&&((j=v.data)!=null&&j.content)?(s.content+=v.data.content,i.text.textContent=s.content):(v==null?void 0:v.event)==="done"&&(s.content=((U=v.data)==null?void 0:U.response)||s.content,i.text.textContent=s.content,l=((K=v.data)==null?void 0:K.tokens)||null,(z=v.data)!=null&&z.model&&(m=v.data.model),(J=v.data)!=null&&J.notice&&y(v.data.notice,"info")),d=""}const A=Math.round(performance.now()-c);s.metadata={model:m,latency:A,tokens:l},ue(i.text,s.content),Z(i.metadata,s.metadata),X(A,l),Q(),ee(),r.isStreaming=!1,k(),D(),I()}catch(C){console.error(C),ee(),P(!1,"AssistMe backend is unreachable. Using preview responses.");let p=null;try{p=yield Tt(e)}catch(A){console.warn("Fallback completion failed",A)}if(p!=null&&p.response){s.content=p.response,i.text.textContent=s.content,l=((W=p==null?void 0:p.usage)==null?void 0:W.tokens)||null,p!=null&&p.notice&&y(p.notice,"info");const A=p==null?void 0:p.conversation_id;typeof A=="number"&&A>0&&(r.activeConversation.localId=r.activeConversation.localId||r.activeConversation.id,r.activeConversation.serverId=A,r.activeConversation.id=`server-${A}`),p!=null&&p.title?r.activeConversation.title=p.title:Me(r.activeConversation);const v=Math.round(performance.now()-c);s.metadata={model:(p==null?void 0:p.model)||t,latency:v,tokens:l},ue(i.text,s.content),Z(i.metadata,s.metadata),X(v,l),Q(),r.isStreaming=!1,k(),D(),I();return}const u=xe(e.content);s.content=u.response,i.text.textContent=s.content;const d=Math.round(performance.now()-c);s.metadata={model:`${t||"offline/mock"}`,latency:d,tokens:u.tokens},Z(i.metadata,s.metadata),X(d,u.tokens),r.isStreaming=!1,k(),y(C.message||"Backend unreachable. Showing offline preview response.","warning"),Q(),D(),I()}})}function Le(e){if(!e)return null;const t=e.split(`
`);let a="message",o="";t.forEach(s=>{const i=s.trim();i&&(i.startsWith("event:")?a=i.slice(6).trim():i.startsWith("data:")&&(o+=i.slice(5).trim()))});try{return{event:a,data:o?JSON.parse(o):null}}catch(s){return console.warn("Failed to parse SSE payload",o,s),{event:a,data:null}}}function me(){return w(this,null,function*(){if(!n.messageInput||!r.activeConversation||r.isStreaming)return;r.currentModel=R(r.currentModel);const e=n.messageInput.value,t=e.trim();if(!t)return;it(e),Q(),Ge(),I();const a={role:"user",content:t,createdAt:Date.now()};r.activeConversation.messages.push(a);const o=ve("user");o.text.textContent=t,D(),yield Mt({role:"user",content:t})})}function Lt(){r.activeConversation&&r.activeConversation.messages.length>0&&D();const e=Re();ye(e),qe(),Ge(),I(),n.welcomePanel&&(n.welcomePanel.style.display="")}function Nt(e){const t=e.target.closest(".conversation-item");!t||!t.dataset.id||r.activeConversation&&t.dataset.id===r.activeConversation.id||At(t.dataset.id)}function re(e){n.messageInput&&(n.messageInput.value=e,k(),me())}function Ne(){n.sidebar&&n.sidebar.classList.toggle("open")}function Ot(){var e,t,a,o,s,i,c,l,m,h,g,b,N,B,T,G,q,V,j,U,K,z,J,W,C,p;(e=n.newChatBtn)==null||e.addEventListener("click",Lt),(t=n.sidebarToggle)==null||t.addEventListener("click",Ne),(a=n.sidebarCloseBtn)==null||a.addEventListener("click",Ne),(o=n.themeToggleBtn)==null||o.addEventListener("click",It),(s=n.conversationSearch)==null||s.addEventListener("input",u=>{ne(u.target.value)}),(i=n.clearHistoryBtn)==null||i.addEventListener("click",()=>{window.confirm("Clear all saved conversations from this device?")&&(r.conversations=[],fe(),ne(),y("Conversation history cleared","info"))}),n.sendButton&&n.sendButton.addEventListener("click",me),n.messageInput&&(n.messageInput.addEventListener("input",k),n.messageInput.addEventListener("keydown",u=>{const d=n.messageInput,v=/Mac|iPod|iPhone|iPad/.test(navigator.platform||navigator.userAgent)?u.metaKey:u.ctrlKey,O=d.selectionStart,S=d.selectionEnd,_=O===S;if(v){const x=u.key.toLowerCase();let f=null;if(x==="b"?f="bold":x==="i"?f="italic":x==="e"&&(f="code"),f){u.preventDefault(),Te(f);return}}if(u.key==="Enter"&&!u.shiftKey&&!v){u.preventDefault(),me();return}if(u.key==="ArrowUp"&&!u.shiftKey&&_&&O===0){u.preventDefault(),Ae("up");return}if(u.key==="ArrowDown"&&!u.shiftKey&&_&&S===d.value.length){u.preventDefault(),Ae("down");return}if(u.key==="Tab"){u.preventDefault();const x=d.value;if(u.shiftKey){const f=x.slice(0,O),M=x.slice(S),Y=f.match(/(?:\n|^)([ \t]{1,4})$/);if(Y){const be=Y[1].length,ke=O-be;d.value=f.slice(0,f.length-be)+M,d.setSelectionRange(ke,ke)}}else{const f="    ";d.value=`${x.slice(0,O)}${f}${x.slice(S)}`;const M=O+f.length;d.setSelectionRange(M,M)}oe(),k();return}})),n.composerQuick&&n.composerQuick.querySelectorAll(".quick-btn").forEach(u=>{u.addEventListener("click",()=>{const d=u.dataset.format;d&&Te(d)})}),(c=n.modelButton)==null||c.addEventListener("click",()=>ge()),(l=n.benchmarkBtn)==null||l.addEventListener("click",u=>{u.preventDefault(),dt()}),(m=n.benchmarkClose)==null||m.addEventListener("click",le),(h=n.benchmarkBackdrop)==null||h.addEventListener("click",le),(g=n.benchmarkTabs)==null||g.addEventListener("click",ut),(b=n.benchmarkCopy)==null||b.addEventListener("click",mt),(N=n.docsBtn)==null||N.addEventListener("click",()=>window.open("https://github.com/mangeshraut712/AssistMe-VirtualAssistant","_blank")),(B=n.conversations)==null||B.addEventListener("click",Nt),(T=n.inlineSuggestions)==null||T.addEventListener("click",u=>{const d=u.target.closest(".suggestion-pill");d!=null&&d.dataset.prompt&&re(d.dataset.prompt)}),(G=n.starterGrid)==null||G.addEventListener("click",u=>{const d=u.target.closest(".welcome-card");d!=null&&d.dataset.prompt&&re(d.dataset.prompt)}),(q=n.pinnedPrompts)==null||q.addEventListener("click",u=>{const d=u.target.closest(".pinned-item");d!=null&&d.dataset.prompt&&re(d.dataset.prompt)}),(V=n.voiceBtn)==null||V.addEventListener("click",Pt),(j=n.uploadBtn)==null||j.addEventListener("click",()=>y("File uploads are coming soon.","info")),(U=n.ai4bharatBtn)==null||U.addEventListener("click",ht),(K=n.ai4bharatClose)==null||K.addEventListener("click",de),(z=n.ai4bharatBackdrop)==null||z.addEventListener("click",de),(J=n.ai4bharatTabs)==null||J.addEventListener("click",vt),(W=n.translateBtn)==null||W.addEventListener("click",yt),(C=n.detectBtn)==null||C.addEventListener("click",bt),(p=n.transliterateBtn)==null||p.addEventListener("click",kt),document.addEventListener("click",St)}function Dt(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e||!n.voiceBtn){n.voiceBtn&&(n.voiceBtn.disabled=!0,n.voiceBtn.title="Voice input not supported by this browser");return}const t=new e;t.lang="en-US",t.interimResults=!1,t.maxAlternatives=1,t.addEventListener("start",()=>{var a;r.voice.listening=!0,(a=n.voiceBtn)==null||a.classList.add("listening"),y("Listening...","info",2e3)}),t.addEventListener("end",()=>{var a;r.voice.listening=!1,(a=n.voiceBtn)==null||a.classList.remove("listening")}),t.addEventListener("result",a=>{const o=Array.from(a.results).map(s=>{var i;return((i=s[0])==null?void 0:i.transcript)||""}).join(" ").trim();o&&(n.messageInput.value=o,k())}),t.addEventListener("error",a=>{var o;r.voice.listening=!1,(o=n.voiceBtn)==null||o.classList.remove("listening"),y(`Voice input error: ${a.error}`,"error")}),r.voice.recognition=t,r.voice.available=!0}function Pt(){if(!(!r.voice.available||!r.voice.recognition))if(r.voice.listening)r.voice.recognition.stop();else try{r.voice.recognition.start()}catch(e){console.warn("Voice recognition error",e)}}function Ht(e){if(!e||!("speechSynthesis"in window))return;const t=new SpeechSynthesisUtterance(e);t.lang="en-US",window.speechSynthesis.cancel(),window.speechSynthesis.speak(t)}function $t(){Et();const e=localStorage.getItem(ie),t=$.map(o=>o.id);e&&!t.includes(e)&&(console.log("Clearing invalid cached model:",e),localStorage.removeItem(ie)),r.currentModel=R(e),he(),r.conversations=Ct().map(o=>{const s=o.localId||(o.serverId?`server-${o.serverId}`:o.id);return se(F({},o),{localId:s,model:R(o.model),messages:Array.isArray(o.messages)?o.messages:[]})}),ne();const a=Re(r.currentModel);ye(a),X(null,null),k()}function Rt(){return w(this,null,function*(){$t(),Ot(),Dt(),P(!0),yield pe(),rt(),yield _t(),I()})}function _t(){return w(this,null,function*(){var e;if(r.backendHealthy===!1){console.info("Skipping server conversation preload: backend offline");return}try{const t=yield fetch(te.conversations,{method:"GET"});if(!t.ok)return;const a=yield t.json();if(!Array.isArray(a)||a.length===0)return;const s=(yield Promise.all(a.slice(0,10).map(i=>w(null,null,function*(){if(!(i!=null&&i.id))return null;try{const c=yield fetch(te.conversationById(i.id));if(!c.ok)return null;const l=yield c.json();return{id:`server-${i.id}`,serverId:i.id,title:i.title||"Untitled chat",model:r.currentModel,createdAt:new Date(i.created_at).getTime(),updatedAt:new Date(i.created_at).getTime(),messages:(l.messages||[]).map(m=>({role:m.role,content:m.content,createdAt:new Date(m.created_at).getTime()}))}}catch(c){return console.warn("Failed to load conversation",i.id,c),null}})))).filter(Boolean);if(s.length>0){const i=new Set(r.conversations.map(c=>c.id));s.forEach(c=>{i.has(c.id)||r.conversations.push(c)}),ne(((e=n.conversationSearch)==null?void 0:e.value)||""),fe()}}catch(t){console.warn("Conversation preload failed",t),P(!1,"AssistMe backend is unreachable. Using preview responses.")}})}Rt();H&&typeof H.setOptions=="function"&&H.setOptions({gfm:!0,breaks:!0,mangle:!1,headerIds:!1,highlight(e,t){if(E!=null&&E.getLanguage&&t&&E.getLanguage(t))return E.highlight(e,{language:t}).value;if(E!=null&&E.highlightAuto)try{return E.highlightAuto(e).value}catch(a){console.warn("Highlight failed",a)}return e}});document.addEventListener("keydown",ft);
